name: Machine Learning Workflow CI

on:
  push:
    branches: [ main ]

jobs:
  train-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install Dependencies
        run: |
          pip install mlflow==2.19.0 dagshub scikit-learn pandas numpy

      - name: Run MLflow Project
        env:
          MLFLOW_TRACKING_USERNAME: ${{ secrets.MLFLOW_USERNAME }}
          MLFLOW_TRACKING_PASSWORD: ${{ secrets.MLFLOW_PASSWORD }}
        run: |
          cd MLProject
          mlflow run . -e main --env-manager local

      # --- PERUBAHAN MULAI DI SINI UNTUK LEVEL SKILLED/ADVANCED ---
      
      - name: Get Latest Run ID
        id: run_id
        run: |
          # Mengambil Run ID terbaru untuk penamaan artefak dan versi
          LATEST_RUN=$(ls -t MLProject/mlruns/0 | head -n 1)
          echo "RUN_ID=$LATEST_RUN" >> $GITHUB_ENV

      - name: Upload Training Artifacts
        uses: actions/upload-artifact@v4
        with:
          # Langkah ini wajib agar reviewer bisa melihat hasil model Anda
          name: spotify-model-artifacts-${{ env.RUN_ID }}
          path: MLProject/mlruns/
          retention-days: 5

      # ------------------------------------------------------------

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker Image
        run: |
          # Menggunakan Run ID sebagai tag agar model memiliki versi yang jelas
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/spotify-model:latest ./MLProject
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/spotify-model:latest ${{ secrets.DOCKERHUB_USERNAME }}/spotify-model:${{ env.RUN_ID }}

      - name: Push Docker Image
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/spotify-model:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/spotify-model:${{ env.RUN_ID }}
